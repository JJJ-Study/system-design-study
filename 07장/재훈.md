# 7장 분산 시스템을 위한 유일 ID 생성기 설계

단일 서버에서 식별자 생성은 보통 데이터베이스의 auto-increment를 활용해서 생성한다.  
그런데 이 방식은 분산 서버에서 사용할 수 없다.  
왜냐하면 데이터베이스 서버가 나누어졌을 때 각 서버에서 id 자동 생성 전략을 취한다고 하더라도 중복되지 않을거라는 보장이 없기 떄문이다.  
지금부터 분산 시스템에서 유일 ID를 생성하는 방법을 알아보자

## 다중 마스터 복제
이 방식은 id 자동 생성 전략으로 1씩 증가시키는 것이 아니라 서버의 개수가 k라면 k씩 증가시키는 방식이다.  
예를 들어 3개의 데이터베이스 서버가 존재한다고 했을 때, 1번 서버에서 1번 id를 생성하면 그 서버에서 다음 id 값은 4를 생성한다.  
그리고 2번 서버에서는 2번 id를 생성하면 그 다음으로 5번, 3번 서버에서는 3번 id를 생성하면 그 다음으로 6번 id를 생성한다.  

### 단점
그러나 이 방식의 단점은 서버의 개수를 늘렸을 때 id 생성 전략을 동일하게 가져가기 어렵다는 단점이 있다.  
물론 어느 시점부터 k+1개씩 늘어나게 변경하면 되겠지만 굉장히 번거로운 작업이 될 것 같다.
즉 이 방식은 서버의 개수의 변화에 유연하게 대응하기 어렵다.

## UUID
UUID를 사용하면 별다른 장치를 사요할 필요 없이 간단하게 식별자를 만들 수 있다.  
UUID를 만들 때 중복 id를 만들 확률은 존재하기는 하지만 거의 없다고 보면 된다.  
위키피디아에서는 아래와 같이 말한다.
> 중복 UUID가 1개 생길 확률을 50%로 끌어 올리려면 초당 10억 개의 UUID를 100년 동안 계속해서 만들어야 한다.

즉 중복되지 않는다고 봐도 무방하다.
하지만 이 방식도 단점이 있다

### 단점
- ID가 128비트로 길다는 단점이 있다.
- 랜덤으로 만들어지기 때문에 시간순으로 정렬할 수 없다. 그렇기 때문에 mysql 같은 경우 재정렬이 계속 일어날 것이다.
- id값에 숫자가 아닌 값이 포함될 수 있다.

## 티켓 서버
id 값을 만드는 단일 서버를 만드는 방식이다.  
모든 데이터 생성은 이 서버를 통해서 만들어지기 떄문에 id가 충돌이 날 가능성은 없다.  
하지만 단일 지점에서 id가 만들어지기 떄문에 장애가 발생하면 서비스 전체에 영향을 준다.  


## 트위터의 스노우플레이크 
이 방식을 사용하면 UUID보다 짧은 64비트로 식별자를 만들 수 있다.  
또한 타임스탬프가 식별자 안에 들어있기 때문에 생성순서대로 정렬이 가능하다.  
이 방식 또한 랜덤으로 만들어지기 때문에 중복 id가 생길 수 있지 초당 40만개의 아이디를 만들 수 있기 때문에 그 확률은 없다고 봐도 무방하다.  
하지만 이 방식은 약 70년 정도의 id값 만들 수 있기 때문에 그 시간이 넘어가면 id 생성기를 새롭게 설정해야한다.  
> 스노우 플레이크의 맨 앞의 1비트를 활용하면 140년 정도까지도 id값을 생성할 수 있다고 한다.
> 70년 정도 유지되는 서비스가 있을까 싶긴 한데, 그 부분을 고려한다면 맨 앞의 사인 비트를 활용해서 늘리도록 하자..
> 그게 아니어도 서버점검을 걸어두고 id 생성기를 다시 설정하면 될 것 같긴 하다
> 