# 7장. 분산 시스템을 위한 유일 ID 생성기 설계

> 프로젝트를 하면서 단순히 UUID를 잘라서 사용했었는데, 이 책에서는 어떤 방식으로 유일 ID를 생성하는지 파악해보자.

단일 시스템의 경우 `auto increment` 를 통해 유일한 ID를 생성할 수 있지만, 분산 환경에서 이 접근법은 통하지 않으며 여러 데이터베이스 서버를 쓰는 경우에는
지연 시간과 같은 문제가 발생할 것이다.

분산 시스템에서는 다음과 같은 선택지가 있다:

- 다중 마스터 복제 (multi-master replication)
- UUID (Universally Unique Identifier)
- 티켓 서버 (ticket server)
- 트위터 스노플레이크 (twitter snowflake)

각 방식에 대해 살펴보자.

## 1. 다중 마스터 복제

데이터베이스의 auto increment 기능을 활용하는데, 다음 ID 값을 1씩 증가하는 것이 아닌 k만큼 증가하는 것이다.  (여기서 k는 데이터베이스 서버의 수다.)

이 방식에는 몇 가지 문제가 있다:
- 여러 데이터 센터에 걸쳐 규모를 늘리기 어렵다.
- ID의 유일성을 보장되겠지만 그 값이 시간 흐름에 맞춰 증가한다는 보장을 할 수 없다.
- 서버를 추가하거나 삭제할 때도 잘 동작하도록 만들기 어렵다.

접근법 자체는 정말 단순하지만 데이터베이스 서버의 수에 대응하기 어려운 것으로 보인다.

## 2. UUID

128비트짜리 UUID 또한, ID를 만드는 하나의 간단한 방법이다.

**장점**

- 충돌 가능성이 정말 낮다.
- 서버 간 조율 없이 독립적으로 생성 가능하다. 즉, 규모 확장도 쉽다.

**단점**

- ID가 128비트로 길다.
- 무작위의 값이기 때문에 시간 순으로 정렬할 수 없으며, 숫자와 문자가 섞여있다.

만들기는 정말 쉽지만, 128비트로 긴 값이고 아침에 만든 UUID가 저녁에 만든 UUID보다 큰 값이 아닐 수 있다.


## 3. 티켓 서버

말 그대로 ID를 생성하는 서버를 두는 방식이다. 티켓 서버를 중앙 집중형으로 하나만 사용하는 것!

**장점**
- 유일성이 보장되는 오직 숫자로만 된 ID를 쉽게 생성할 수 있다.
- 구현하기 쉽고, 중소 규모 애플리케이션이 적합.

**단점**
- SPOF(Single-Point-of-Failure)가 된다. 장애가 발생하면 모든 시스템에 영향을 미친다.

재미있는 방식이며, 사용해보고 싶지만, 단점이 너무 명확하다. 서버가 다운되는 상황을 대비하기 위해 새로운 서버를 두자니, ID 값 동기화는 어떻게?..


## 4. 트위터 스노우플레이크

트위터에서 독창적인 ID 생성 기법인 스노우플레이크 기법을 사용한다.

- 생성해야하는 ID의 구조를 여러 부분(section)으로 분할하는 것이다.

64비트를 다음과 같은 구조로 나눈다:

- 사인(sign) 비트: 1비트
- 타임스탬프(timestamp): 41비트, 기원 시각(epoch) 이후로 몇 millisecond 지났는지 나타내는 값
- 데이터센터 ID: 5비트, 32개 데이터 센터를 지원
- 서버 ID: 5비트, 데이터센터 당 32개의 서버 지원
- 일련번호: 12비트, 각 서버에서 ID를 생성할 때마다 1씩 증가한다. 이 값은 1 millisecond 가 지나면 0으로 초기화된다.


---

데이터베이스의 auto increment 기법을 활용하는 방식과 시간과 관련된 방식으로 유일 ID를 생성하는 방법이 보편적인 것 같다.

이러한 방식을 잘 살려서 프로젝트에 있는 내용도 리팩토링하면 좋을 것 같다. 